@page "/ui/login"
@using System.ComponentModel.DataAnnotations
@using EventStore.Plugins.Authentication
@using KurrentDB.Services
@using Microsoft.AspNetCore.Http

<EditForm Model="Input" OnValidSubmit="LoginUser" FormName="LoginUser">
	<DataAnnotationsValidator/>
	<MudGrid>
		<MudItem xs="6">
			<MudCard>
				<MudCardContent>
					<MudTextField Label="Username" HelperText="Enter your username" AutoFocus="true"
					              @bind-Value="Input.Username" For="@(() => Input.Username)"/>
					<MudTextField Label="Password" HelperText="Enter your password" Class="mt-3"
					              @bind-Value="Input.Password" For="@(() => Input.Password)"
					              InputType="InputType.Password"/>
				</MudCardContent>
				<MudCardActions>
					<MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary"
					           Class="ml-auto">Log in
					</MudButton>
					<ValidationSummary></ValidationSummary>
				</MudCardActions>
			</MudCard>
		</MudItem>
		<MudFlexBreak />
		<MudItem xs="6">
		</MudItem>
	</MudGrid>
</EditForm>

@code {
	[Inject] NavigationManager NavigationManager { get; set; }
	[Inject] IAuthenticationProvider AuthProvider { get; set; }
	[Inject] AuthService AuthService { get; set; }
	[Inject] ISnackbar Snackbar { get; set; }
	[SupplyParameterFromForm] LoginInputModel Input { get; set; } = new();
	[SupplyParameterFromQuery] string ReturnUrl { get; set; }

	protected override async Task OnAfterRenderAsync(bool firstRender) {
		if (firstRender && !AuthService.IsLoggedIn) {
			var restoredFromState = await AuthService.GetStateFromTokenAsync();
			if (restoredFromState) {
				if (!string.IsNullOrEmpty(ReturnUrl)) {
					NavigationManager.NavigateTo(ReturnUrl);
				}
			}
		}
	}

	public async Task LoginUser() {
		var request = new HttpAuthenticationRequest(new DefaultHttpContext(), Input.Username, Input.Password);
		AuthProvider.Authenticate(request);
		var (status, principal) = await request.AuthenticateAsync();

		if (status != HttpAuthenticationRequestStatus.Authenticated) {
			Snackbar.Add("Invalid username or password", Severity.Error);
			return;
		}

		await AuthService.Login(principal);
		NavigationManager.NavigateTo(ReturnUrl ?? "/");
	}

	private sealed class LoginInputModel {
		[Required] public string Username { get; set; } = "";

		[Required]
		[DataType(DataType.Password)]
		public string Password { get; set; } = "";
	}
}
