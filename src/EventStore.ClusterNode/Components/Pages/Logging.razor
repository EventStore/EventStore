@page "/ui/logs"
@using System.ComponentModel
@using EventStore.ClusterNode.Services
@using Serilog.Events
@inject LogObserver LogObserver
@implements IDisposable

<PageTitle>KurrentDB: Logs</PageTitle>

<MudDataGrid @ref="_dataGrid" Items="@LogObserver.Items" Dense="@true" Filterable="true">
	@* Style="font-size: 0.5em;"> *@
	<Columns>
		<PropertyColumn Property="x => x.Timestamp" Title="Timestamp" Format="HH:mm:ss" Filterable="@false"/>
		<PropertyColumn Property="x => x.Level" Title="Level" CellStyleFunc="_cellStyleFunc"/>
		<PropertyColumn Property="x => x.MessageTemplate.Render(x.Properties, null)" Title="Message"
		                CellStyleFunc="_cellStyleFunc"/>
	</Columns>
</MudDataGrid>
@if (LogObserver.Items.Count == 0) {
	<MudText>Waiting for log events...</MudText>
}


@code {
	MudDataGrid<LogEvent> _dataGrid;

	protected override Task OnInitializedAsync() {
		LogObserver.PropertyChanged += HandleUpdate;
		return base.OnInitializedAsync();
	}

	void HandleUpdate(object sender, PropertyChangedEventArgs e) {
		Task.Run(() => InvokeAsync(Update));
	}

	protected override async Task OnAfterRenderAsync(bool firstRender) {
		await base.OnAfterRenderAsync(firstRender);
		await _dataGrid.SetSortAsync(nameof(LogEvent.Timestamp), SortDirection.Descending, x => x.Timestamp);
	}

	Func<LogEvent, string> _cellStyleFunc => x => {
		var color = x.Level switch {
			LogEventLevel.Verbose => "",
			LogEventLevel.Debug => "",
			LogEventLevel.Information => "--mud-palette-dark-text",
			LogEventLevel.Warning => "--mud-palette-warning",
			LogEventLevel.Error => "--mud-palette-error",
			LogEventLevel.Fatal => "--mud-palette-error",
			_ => throw new ArgumentOutOfRangeException()
		};
		var style = color != "" ? $"color: var({color});" : "";
		return style;
	};

	public void Dispose() {
		LogObserver.PropertyChanged -= HandleUpdate;
	}

	void Update() {
		StateHasChanged();
	}

}
